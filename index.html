<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á§æ‰∫§Â™í‰ΩìÂèëÂ∏ÉÊó•ÂéÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f8f9fa;
        }
        .calendar-cell {
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .calendar-cell:hover {
            border-color: #d1d5db;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .today-cell {
            background-color: #86efac !important;
            border-color: #22c55e;
        }
        .past-cell {
            background-color: #f9fafb;
            color: #9ca3af;
        }
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        .media-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .media-container img,
        .media-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        .nav-button {
            min-width: 48px;
            min-height: 48px;
            flex-shrink: 0;
        }
        .calendar-video {
            transition: opacity 0.3s ease;
        }
        .calendar-video:hover {
            opacity: 0.9;
        }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // SupabaseÈÖçÁΩÆ - Â∑≤ÈÖçÁΩÆÊÇ®ÁöÑÈ°πÁõÆÂá≠ÊçÆ
        const SUPABASE_URL = 'https://twmzmxuhddwdpylziabm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3bXpteHVoZGR3ZHB5bHppYWJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MDM2NjYsImV4cCI6MjA2OTQ3OTY2Nn0._EBOw9cp7b9kN0_76STtY4D99deb8OLyQH4IEJ5l8AM';
        
        // ÂàùÂßãÂåñSupabaseÂÆ¢Êà∑Á´Ø
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Ê£ÄÊü•SupabaseÊòØÂê¶ÈÖçÁΩÆÊ≠£Á°Æ
        const isSupabaseConfigured = SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY';
        
        // Ë∞ÉËØïÊ®°ÂºèÂºÄÂÖ≥ - Âú®Áîü‰∫ßÁéØÂ¢É‰∏≠ÂèØ‰ª•ËÆæ‰∏∫false
        const DEBUG_MODE = true;
        
        // üì¶ Êô∫ËÉΩÂ≠òÂÇ®Á≠ñÁï•ÈÖçÁΩÆ
        const STORAGE_CONFIG = {
            // Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂ÔºàÂ≠óËäÇÔºâ
            MAX_LOCAL_FILE_SIZE: 50 * 1024 * 1024,  // 50MBÊú¨Âú∞Â≠òÂÇ®ÈôêÂà∂
            MAX_CLOUD_FILE_SIZE: 100 * 1024 * 1024, // 100MB‰∫ëÁ´ØÂ≠òÂÇ®ÈôêÂà∂
            
            // ÂéãÁº©ÈÖçÁΩÆ
            IMAGE_QUALITY: 0.8,                     // ÂõæÁâáÂéãÁº©Ë¥®Èáè
            VIDEO_QUALITY: 0.7,                     // ËßÜÈ¢ëÂéãÁº©Ë¥®Èáè
            THUMBNAIL_SIZE: 200,                    // Áº©Áï•ÂõæÂ∞∫ÂØ∏
            
            // Â≠òÂÇ®Á≠ñÁï•
            AUTO_CLOUD_SYNC: true,                  // Ëá™Âä®‰∫ëÁ´ØÂêåÊ≠•
            PREFER_LOCAL: true,                     // ‰ºòÂÖàÊú¨Âú∞Â≠òÂÇ®
            ENABLE_COMPRESSION: true,               // ÂêØÁî®ÂéãÁº©
            
            // ÂêåÊ≠•Èó¥Èöî
            SYNC_DELAY: 2000,                       // ÂêåÊ≠•Âª∂ËøüÔºàÊØ´ÁßíÔºâ
        };
        
        // üì¶ Êô∫ËÉΩÂ≠òÂÇ®ÁÆ°ÁêÜÂô®
        class SmartStorageManager {
            constructor() {
                this.storageStats = {
                    localSize: 0,
                    cloudSize: 0,
                    totalFiles: 0,
                    syncStatus: 'idle' // idle, syncing, error, success
                };
            }

            // üîç Ê£ÄÊµãÊñá‰ª∂Â≠òÂÇ®Á≠ñÁï•
            determineStorageStrategy(file) {
                const fileSize = file.size;
                const isLargeFile = fileSize > STORAGE_CONFIG.MAX_LOCAL_FILE_SIZE;
                const isHugeFile = fileSize > STORAGE_CONFIG.MAX_CLOUD_FILE_SIZE;
                
                return {
                    storeLocal: !isHugeFile, // Âè™Ë¶Å‰∏çË∂ÖËøá‰∫ëÁ´ØÈôêÂà∂Â∞±Êú¨Âú∞Â≠òÂÇ®
                    storeCloud: STORAGE_CONFIG.AUTO_CLOUD_SYNC && !isHugeFile,
                    needsCompression: isLargeFile && STORAGE_CONFIG.ENABLE_COMPRESSION,
                    createThumbnail: file.type.startsWith('video/') || isLargeFile
                };
            }

            // üìä ËÆ°ÁÆóÊú¨Âú∞Â≠òÂÇ®‰ΩøÁî®Èáè
            calculateLocalStorageSize() {
                try {
                    const data = localStorage.getItem('socialMediaCalendar');
                    return data ? new Blob([data]).size : 0;
                } catch (error) {
                    console.warn('Êó†Ê≥ïËÆ°ÁÆóÊú¨Âú∞Â≠òÂÇ®Â§ßÂ∞è:', error);
                    return 0;
                }
            }

            // üíæ Êô∫ËÉΩÊñá‰ª∂Â§ÑÁêÜ
            async processFile(file) {
                const strategy = this.determineStorageStrategy(file);
                console.log(`üì¶ Êñá‰ª∂ ${file.name} Â≠òÂÇ®Á≠ñÁï•:`, strategy);

                let result = {
                    type: file.type.startsWith('image/') ? 'image' : 'video',
                    name: file.name,
                    size: file.size,
                    file: file,
                    storageStrategy: strategy
                };

                try {
                    // 1. ÁîüÊàêÁº©Áï•ÂõæÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                    if (strategy.createThumbnail) {
                        if (file.type.startsWith('video/')) {
                            result.thumbnail = await this.createVideoThumbnail(file);
                        } else {
                            result.thumbnail = await this.createImageThumbnail(file);
                        }
                    }

                    // 2. Â§ÑÁêÜÊú¨Âú∞Â≠òÂÇ®
                    if (strategy.storeLocal) {
                        if (strategy.needsCompression) {
                            result.dataUrl = await this.compressFile(file);
                            result.isCompressed = true;
                        } else {
                            result.dataUrl = await this.fileToDataUrl(file);
                            result.isCompressed = false;
                        }
                        result.originalDataUrl = result.dataUrl;
                    }

                    // 3. Ê†áËÆ∞‰∫ëÁ´ØÂ≠òÂÇ®ÈúÄÊ±Ç
                    if (strategy.storeCloud) {
                        result.needsCloudUpload = true;
                    }

                    console.log(`‚úÖ Êñá‰ª∂ ${file.name} Â§ÑÁêÜÂÆåÊàê`);
                    return result;

                } catch (error) {
                    console.error(`‚ùå Êñá‰ª∂ ${file.name} Â§ÑÁêÜÂ§±Ë¥•:`, error);
                    
                    // Ê†πÊçÆÈîôËØØÁ±ªÂûãÊèê‰æõÊõ¥ÂÖ∑‰ΩìÁöÑÈîôËØØ‰ø°ÊÅØ
                    let errorMessage = error.message;
                    if (error.name === 'QuotaExceededError') {
                        errorMessage = 'Êñá‰ª∂ËøáÂ§ßÔºåË∂ÖÂá∫Â≠òÂÇ®ÈôêÂà∂';
                    } else if (error.message.includes('network')) {
                        errorMessage = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ËøûÊé•';
                    } else if (error.message.includes('format')) {
                        errorMessage = 'Êñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅ';
                    } else if (error.message.includes('canvas')) {
                        errorMessage = 'ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåÂèØËÉΩÊñá‰ª∂ÊçüÂùè';
                    }
                    
                    // ËøîÂõûÂü∫Á°Ä‰ø°ÊÅØÔºåÂç≥‰ΩøÂ§ÑÁêÜÂ§±Ë¥•
                    return {
                        ...result,
                        error: errorMessage,
                        dataUrl: result.thumbnail || null,
                        hasError: true
                    };
                }
            }

            // üñºÔ∏è ÂàõÂª∫ÂõæÁâáÁº©Áï•Âõæ
            async createImageThumbnail(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    img.onload = () => {
                        const size = STORAGE_CONFIG.THUMBNAIL_SIZE;
                        canvas.width = size;
                        canvas.height = size;
                        
                        // Â±Ö‰∏≠Ë£ÅÂâ™
                        const minDim = Math.min(img.width, img.height);
                        const scale = size / minDim;
                        const scaledWidth = img.width * scale;
                        const scaledHeight = img.height * scale;
                        const x = (size - scaledWidth) / 2;
                        const y = (size - scaledHeight) / 2;
                        
                        ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            }

            // üé• ÂàõÂª∫ËßÜÈ¢ëÁº©Áï•Âõæ
            async createVideoThumbnail(file) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    video.addEventListener('loadeddata', () => {
                        try {
                            const size = STORAGE_CONFIG.THUMBNAIL_SIZE;
                            canvas.width = size;
                            canvas.height = size;
                            
                            // Â±Ö‰∏≠Ë£ÅÂâ™
                            const scale = size / Math.min(video.videoWidth, video.videoHeight);
                            const scaledWidth = video.videoWidth * scale;
                            const scaledHeight = video.videoHeight * scale;
                            const x = (size - scaledWidth) / 2;
                            const y = (size - scaledHeight) / 2;
                            
                            ctx.drawImage(video, x, y, scaledWidth, scaledHeight);
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        } catch (error) {
                            reject(error);
                        }
                    });

                    video.addEventListener('error', reject);
                    video.src = URL.createObjectURL(file);
                    video.currentTime = 1; // Ëé∑ÂèñÁ¨¨1ÁßíÁöÑÁîªÈù¢
                });
            }

            // üóúÔ∏è ÂéãÁº©Êñá‰ª∂
            async compressFile(file) {
                if (file.type.startsWith('image/')) {
                    return this.compressImage(file);
                } else if (file.type.startsWith('video/')) {
                    // ËßÜÈ¢ëÂéãÁº©ÊØîËæÉÂ§çÊùÇÔºåÂÖàËøîÂõûÂéüÊñá‰ª∂DataURL
                    return this.fileToDataUrl(file);
                }
                return this.fileToDataUrl(file);
            }

            // üñºÔ∏è ÂéãÁº©ÂõæÁâá
            async compressImage(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    img.onload = () => {
                        // ËÆ°ÁÆóÂéãÁº©Â∞∫ÂØ∏
                        let { width, height } = img;
                        const maxDimension = 1920; // ÊúÄÂ§ßÂ∞∫ÂØ∏
                        
                        if (width > maxDimension || height > maxDimension) {
                            const ratio = Math.min(maxDimension / width, maxDimension / height);
                            width *= ratio;
                            height *= ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', STORAGE_CONFIG.IMAGE_QUALITY));
                    };
                    
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            }

            // üìÑ Êñá‰ª∂ËΩ¨DataURL
            async fileToDataUrl(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // üìä Êõ¥Êñ∞Â≠òÂÇ®ÁªüËÆ°
            updateStats(posts) {
                let totalSize = 0;
                let fileCount = 0;

                Object.values(posts).forEach(dayPosts => {
                    dayPosts.forEach(post => {
                        if (post.files) {
                            post.files.forEach(file => {
                                fileCount++;
                                if (file.size) totalSize += file.size;
                            });
                        }
                    });
                });

                this.storageStats = {
                    ...this.storageStats,
                    localSize: this.calculateLocalStorageSize(),
                    totalFiles: fileCount
                };

                return this.storageStats;
            }

            // üßπ Ê∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥
            cleanupStorage(posts) {
                console.log('üßπ ÂºÄÂßãÊ∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥...');
                let cleaned = false;
                
                // 1. Ê∏ÖÁêÜ30Â§©ÂâçÁöÑÊï∞ÊçÆ
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                Object.keys(posts).forEach(dateKey => {
                    const postDate = new Date(dateKey);
                    if (postDate < thirtyDaysAgo) {
                        console.log(`üóëÔ∏è Ê∏ÖÁêÜËøáÊúüÊï∞ÊçÆ: ${dateKey}`);
                        delete posts[dateKey];
                        cleaned = true;
                    }
                });
                
                // 2. ÂéãÁº©Â§ßÊñá‰ª∂ÁöÑDataURL
                Object.values(posts).forEach(dayPosts => {
                    dayPosts.forEach(post => {
                        if (post.files) {
                            post.files.forEach(file => {
                                if (file.dataUrl && file.dataUrl.length > 1024 * 1024 && !file.isCompressed) {
                                    // Â¶ÇÊûúDataURLË∂ÖËøá1MB‰∏îÊú™ÂéãÁº©ÔºåÊ†áËÆ∞ÈúÄË¶ÅÈáçÊñ∞Â§ÑÁêÜ
                                    file.needsReprocessing = true;
                                    cleaned = true;
                                }
                            });
                        }
                    });
                });
                
                if (cleaned) {
                    console.log('‚úÖ Â≠òÂÇ®Ê∏ÖÁêÜÂÆåÊàê');
                }
                
                return posts;
            }
        }

        // ÂÖ®Â±ÄÂ≠òÂÇ®ÁÆ°ÁêÜÂô®ÂÆû‰æã
        const storageManager = new SmartStorageManager();

        // ÂõæÊ†áÁªÑ‰ª∂
        const ChevronLeft = () => <span>‚Äπ</span>;
        const ChevronRight = () => <span>‚Ä∫</span>;
        const XCircle = () => <span>√ó</span>;

        // SupabaseÊï∞ÊçÆÊúçÂä°
        const SupabaseService = {
            // ‰∏ä‰º†Êñá‰ª∂Âà∞Supabase Storage (ÊîØÊåÅËøõÂ∫¶ÂõûË∞É)
            async uploadFile(file, fileName, userId, progressCallback = null) {
                try {
                    // È™åËØÅÊñá‰ª∂
                    if (!file || !fileName || !userId) {
                        console.error('‰∏ä‰º†ÂèÇÊï∞‰∏çÂÆåÊï¥:', { file: !!file, fileName, userId });
                        return null;
                    }

                    const fileExt = fileName.split('.').pop();
                    const filePath = `${userId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    
                    if (DEBUG_MODE) console.log(`ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂: ${fileName}, Â§ßÂ∞è: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                    
                    // ÂØπ‰∫éÂ§ßÊñá‰ª∂ÔºåÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
                    if (progressCallback) {
                        progressCallback(0, fileName);
                    }

                    // ÂàõÂª∫‰∏Ä‰∏™ÂåÖË£ÖÁöÑÊñá‰ª∂ÂØπË±°Êù•Ê®°ÊãüËøõÂ∫¶
                    let uploadPromise;
                    
                    if (file.size > 1024 * 1024) { // Â§ß‰∫é1MBÁöÑÊñá‰ª∂ÊòæÁ§∫ËøõÂ∫¶
                        // ÂàõÂª∫Ê®°ÊãüËøõÂ∫¶ÁöÑPromise
                        uploadPromise = new Promise(async (resolve, reject) => {
                            try {
                                // Ê®°Êãü‰∏ä‰º†ËøõÂ∫¶
                                let currentProgress = 0;
                                const progressInterval = setInterval(() => {
                                    if (progressCallback && currentProgress < 85) {
                                        currentProgress += Math.random() * 15 + 5;
                                        currentProgress = Math.min(85, currentProgress);
                                        progressCallback(currentProgress, fileName);
                                    }
                                }, 300);

                                const { data, error } = await supabase.storage
                                    .from('media-files')
                                    .upload(filePath, file, {
                                        cacheControl: '3600',
                                        upsert: false
                                    });

                                clearInterval(progressInterval);
                                
                                if (progressCallback) {
                                    progressCallback(100, fileName);
                                }

                                if (error) {
                                    reject(error);
                                } else {
                                    resolve({ data, error });
                                }
                            } catch (err) {
                                reject(err);
                            }
                        });
                    } else {
                        // Â∞èÊñá‰ª∂Áõ¥Êé•‰∏ä‰º†
                        uploadPromise = supabase.storage
                            .from('media-files')
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                    }

                    const { data, error } = await uploadPromise;

                    if (error) {
                        console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
                        if (progressCallback) {
                            progressCallback(-1, fileName, error.message);
                        }
                        return null;
                    }

                    // Ëé∑ÂèñÂÖ¨ÂÖ±URL
                    const { data: { publicUrl } } = supabase.storage
                        .from('media-files')
                        .getPublicUrl(filePath);

                    if (DEBUG_MODE) console.log(`Êñá‰ª∂‰∏ä‰º†ÊàêÂäü: ${fileName} -> ${publicUrl}`);

                    return {
                        filePath: filePath,
                        publicUrl: publicUrl,
                        fileName: fileName,
                        fileSize: file.size,
                        fileType: file.type
                    };
                } catch (error) {
                    console.error('‰∏ä‰º†Êñá‰ª∂ÈîôËØØ:', error);
                    if (progressCallback) {
                        progressCallback(-1, fileName, error.message);
                    }
                    return null;
                }
            },

            // Âà†Èô§Êñá‰ª∂‰ªéSupabase Storage
            async deleteFile(filePath) {
                try {
                    const { error } = await supabase.storage
                        .from('media-files')
                        .remove([filePath]);
                    
                    if (error) {
                        console.error('Âà†Èô§Êñá‰ª∂Â§±Ë¥•:', error);
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Âà†Èô§Êñá‰ª∂ÈîôËØØ:', error);
                    return false;
                }
            },

            // ÊâπÈáè‰∏ä‰º†Êñá‰ª∂
            async uploadFiles(files, userId) {
                const uploadPromises = files.map(async (fileData) => {
                    if (fileData.file) {
                        // Â¶ÇÊûúÊúâÂéüÂßãÊñá‰ª∂Ôºå‰∏ä‰º†Âà∞‰∫ëÁ´Ø
                        const uploadResult = await this.uploadFile(fileData.file, fileData.name, userId);
                        if (uploadResult) {
                            return {
                                ...fileData,
                                cloudUrl: uploadResult.publicUrl,
                                cloudPath: uploadResult.filePath,
                                uploaded: true
                            };
                        }
                    }
                    return {
                        ...fileData,
                        uploaded: false
                    };
                });

                return await Promise.all(uploadPromises);
            },

            // ‰øùÂ≠òÂèëÂ∏ÉÂÜÖÂÆπÂà∞‰∫ëÁ´ØÔºàÂåÖÂê´Êñá‰ª∂‰∏ä‰º†Ôºâ
            async savePosts(posts, progressCallback = null) {
                if (!isSupabaseConfigured) return;
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    if (DEBUG_MODE) console.log('ÂºÄÂßã‰øùÂ≠òÊï∞ÊçÆÂà∞‰∫ëÁ´Ø...');

                    // Â§ÑÁêÜÊØè‰∏™Êó•ÊúüÁöÑÂ∏ñÂ≠ê
                    for (const [date, dayPosts] of Object.entries(posts)) {
                        for (const post of dayPosts) {
                            try {
                                // ÊöÇÊó∂Ë∑≥ËøáÊñá‰ª∂‰∏ä‰º†Ôºå‰ªÖ‰øùÂ≠òÊñáÊ°àÂíåÂπ≥Âè∞‰ø°ÊÅØ
                                let uploadedFiles = post.files || [];
                                
                                // ÈáçÊñ∞ÂêØÁî®Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩÔºå‰ΩøÁî®Êõ¥ÂÆâÂÖ®ÁöÑÊñπÂºè
                                if (post.files && post.files.length > 0) {
                                    if (DEBUG_MODE) console.log(`Ê≠£Âú®‰∏ä‰º† ${post.files.length} ‰∏™Êñá‰ª∂...`);
                                    
                                    uploadedFiles = []; // ÈáçÊñ∞ÂàùÂßãÂåñ
                                    
                                    for (const fileData of post.files) {
                                        try {
                                            if (fileData.file && !fileData.cloudUrl && !fileData.uploaded) {
                                                // Â∞ùËØï‰∏ä‰º†Êñ∞Êñá‰ª∂
                                                if (DEBUG_MODE) console.log(`Â∞ùËØï‰∏ä‰º†Êñá‰ª∂: ${fileData.name}`);
                                                const uploadResult = await this.uploadFile(fileData.file, fileData.name, user.id, progressCallback);
                                                
                                                if (uploadResult) {
                                                    uploadedFiles.push({
                                                        ...fileData,
                                                        cloudUrl: uploadResult.publicUrl,
                                                        cloudPath: uploadResult.filePath,
                                                        uploaded: true,
                                                        // ÂØπ‰∫éËßÜÈ¢ëÔºå‰øùÁïôÁº©Áï•Âõæ‰Ωú‰∏∫È¢ÑËßàÔºå‰∫ëÁ´ØURL‰Ωú‰∏∫Êí≠ÊîæÊ∫ê
                                                        dataUrl: fileData.type === 'video' ? fileData.thumbnail : fileData.dataUrl,
                                                        originalDataUrl: uploadResult.publicUrl, // ‰ΩøÁî®‰∫ëÁ´ØURL‰Ωú‰∏∫ÂéüÂßãURL
                                                        file: null // Ê∏ÖÈô§ÂéüÂßãÊñá‰ª∂ÂØπË±°ÔºåËäÇÁúÅÂÜÖÂ≠ò
                                                    });
                                                    if (DEBUG_MODE) console.log(`Êñá‰ª∂‰∏ä‰º†ÊàêÂäü: ${fileData.name}`);
                                                } else {
                                                    // ‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÁïôÂéüÂßãÊï∞ÊçÆ‰ΩÜÊ†áËÆ∞‰∏∫Êú¨Âú∞Êñá‰ª∂
                                                    uploadedFiles.push({
                                                        ...fileData,
                                                        uploaded: false
                                                    });
                                                    if (DEBUG_MODE) console.log(`Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•Ôºå‰øùÁïôÊú¨Âú∞: ${fileData.name}`);
                                                }
                                            } else {
                                                // Â∑≤Áªè‰∏ä‰º†ËøáÁöÑÊñá‰ª∂ÊàñÂ∑≤Êúâ‰∫ëÁ´ØURL
                                                uploadedFiles.push({
                                                    ...fileData,
                                                    uploaded: fileData.cloudUrl ? true : false
                                                });
                                            }
                                        } catch (fileError) {
                                            if (DEBUG_MODE) console.error(`Â§ÑÁêÜÊñá‰ª∂Â§±Ë¥•: ${fileData.name}`, fileError);
                                            // Âç≥‰ΩøÂá∫Èîô‰πü‰øùÁïôÊñá‰ª∂
                                            uploadedFiles.push({
                                                ...fileData,
                                                uploaded: false
                                            });
                                        }
                                    }
                                }

                                // ‰øùÂ≠òÂ∏ñÂ≠êÊï∞ÊçÆÂà∞Êï∞ÊçÆÂ∫ì
                                const postData = {
                                    user_id: user.id,
                                    date,
                                    caption: post.caption || '',
                                    platforms: post.platforms || []
                                };

                                // Âà†Èô§ËØ•Êó•ÊúüÁöÑÁé∞ÊúâÊï∞ÊçÆ
                                await supabase.from('posts').delete().eq('user_id', user.id).eq('date', date);
                                
                                // ÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                                const { data: insertedPost, error: postError } = await supabase
                                    .from('posts')
                                    .insert(postData)
                                    .select()
                                    .single();

                                if (postError) {
                                    console.log('Êï∞ÊçÆÂ∫ìË°®Â∞öÊú™ÂàõÂª∫ÔºåË∑≥ËøáÊï∞ÊçÆÂ∫ì‰øùÂ≠ò');
                                    continue;
                                }

                                // ‰øùÂ≠òÊñá‰ª∂‰ø°ÊÅØÂà∞Êï∞ÊçÆÂ∫ì
                                if (uploadedFiles.length > 0 && insertedPost) {
                                    const mediaData = uploadedFiles.map(file => ({
                                        post_id: insertedPost.id,
                                        file_name: file.name,
                                        file_type: file.type.startsWith('image') ? 'image' : 'video',
                                        file_url: file.cloudUrl || file.dataUrl,
                                        thumbnail_url: file.thumbnail,
                                        compressed_url: file.dataUrl,
                                        file_size: file.size,
                                        original_name: file.name
                                    }));

                                    const { error: mediaError } = await supabase
                                        .from('media_files')
                                        .insert(mediaData);

                                    if (mediaError) {
                                        console.log('Â™í‰ΩìÊñá‰ª∂Ë°®Â∞öÊú™ÂàõÂª∫Ôºå‰ªÖ‰øùÂ≠òÂ∏ñÂ≠êÊï∞ÊçÆ');
                                    }
                                }

                                // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ‰∏≠ÁöÑ‰∫ëÁ´Ø‰ø°ÊÅØ
                                if (uploadedFiles.length > 0) {
                                    post.files = uploadedFiles;
                                }

                            } catch (postError) {
                                console.error('‰øùÂ≠òÂçï‰∏™Â∏ñÂ≠êÂ§±Ë¥•:', postError);
                            }
                        }
                    }

                                                        if (DEBUG_MODE) console.log('‰∫ëÁ´Ø‰øùÂ≠òÂÆåÊàê');
                                    
                                    // ÁªüËÆ°‰∏ä‰º†ÁªìÊûú
                                    const totalFiles = Object.values(posts).reduce((total, dayPosts) => {
                                        return total + dayPosts.reduce((dayTotal, post) => {
                                            return dayTotal + (post.files ? post.files.length : 0);
                                        }, 0);
                                    }, 0);
                                    
                                    if (totalFiles > 0) {
                                        if (DEBUG_MODE) console.log(`Â§ÑÁêÜ‰∫Ü ${totalFiles} ‰∏™Êñá‰ª∂`);
                                    }
                } catch (error) {
                    console.error('Supabase‰øùÂ≠òÈîôËØØ:', error);
                }
            },

            // Âè™‰øùÂ≠òÊñáÊ°àÂà∞‰∫ëÁ´ØÔºà‰∏ç‰∏ä‰º†Êñá‰ª∂Ôºâ
            async savePostsTextOnly(posts) {
                if (!isSupabaseConfigured) return;
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    if (DEBUG_MODE) console.log('ÂºÄÂßãÂêåÊ≠•ÊñáÊ°àÂà∞‰∫ëÁ´Ø...');

                    // Âè™Â§ÑÁêÜÊñáÊ°àÂíåÂπ≥Âè∞‰ø°ÊÅØÔºåË∑≥ËøáÊñá‰ª∂
                    for (const [date, dayPosts] of Object.entries(posts)) {
                        for (const post of dayPosts) {
                            try {
                                // ‰øùÂ≠òÂ∏ñÂ≠êÊï∞ÊçÆÂà∞Êï∞ÊçÆÂ∫ìÔºà‰∏çÂåÖÂê´Êñá‰ª∂Ôºâ
                                const postData = {
                                    user_id: user.id,
                                    date,
                                    caption: post.caption || '',
                                    platforms: post.platforms || []
                                };

                                // Âà†Èô§ËØ•Êó•ÊúüÁöÑÁé∞ÊúâÊï∞ÊçÆ
                                await supabase.from('posts').delete().eq('user_id', user.id).eq('date', date);
                                
                                // ÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                                const { error: postError } = await supabase
                                    .from('posts')
                                    .insert(postData);

                                if (postError) {
                                    if (DEBUG_MODE) console.log('Êï∞ÊçÆÂ∫ìË°®Â∞öÊú™ÂàõÂª∫ÔºåË∑≥ËøáÊï∞ÊçÆÂ∫ì‰øùÂ≠ò');
                                    continue;
                                }

                            } catch (postError) {
                                console.error('‰øùÂ≠òÂçï‰∏™Â∏ñÂ≠êÂ§±Ë¥•:', postError);
                            }
                        }
                    }

                    if (DEBUG_MODE) console.log('ÊñáÊ°àÂêåÊ≠•ÂÆåÊàê');
                } catch (error) {
                    console.error('SupabaseÊñáÊ°àÂêåÊ≠•ÈîôËØØ:', error);
                }
            },

            // ‰ªé‰∫ëÁ´ØÂä†ËΩΩÂèëÂ∏ÉÂÜÖÂÆπÔºàÂåÖÂê´Êñá‰ª∂Ôºâ
            async loadPosts() {
                if (!isSupabaseConfigured) return null;
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return null;

                    console.log('‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ...');

                    // Â∞ùËØï‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÔºåÂ¶ÇÊûúÂ§±Ë¥•Â∞±ËøîÂõûnullÔºà‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆÔºâ
                    try {
                        // Âä†ËΩΩÂ∏ñÂ≠êÊï∞ÊçÆÔºåÂåÖÂê´ÂÖ≥ËÅîÁöÑÂ™í‰ΩìÊñá‰ª∂
                        const { data: postsData, error: postsError } = await supabase
                            .from('posts')
                            .select(`
                                *,
                                media_files (*)
                            `)
                            .eq('user_id', user.id)
                            .order('date', { ascending: true });

                        if (postsError) {
                            console.log('‰∫ëÁ´ØÊöÇÊó†Êï∞ÊçÆÔºå‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆ');
                            return null;
                        }

                        if (!postsData || postsData.length === 0) {
                            console.log('‰∫ëÁ´ØÊï∞ÊçÆ‰∏∫Á©∫');
                            return {};
                        }

                        // ËΩ¨Êç¢‰∏∫ÂéüÊúâÊ†ºÂºè
                        const posts = {};
                        postsData.forEach(post => {
                            if (!posts[post.date]) posts[post.date] = [];
                            
                            // Â§ÑÁêÜÂ™í‰ΩìÊñá‰ª∂
                            const files = (post.media_files || []).map(mediaFile => {
                                const isVideo = mediaFile.file_type === 'video';
                                return {
                                    name: mediaFile.original_name || mediaFile.file_name,
                                    type: isVideo ? 'video' : 'image',
                                    size: mediaFile.file_size || 0,
                                    // ÂØπ‰∫éËßÜÈ¢ëÔºödataUrlÁî®Áº©Áï•ÂõæÈ¢ÑËßàÔºåoriginalDataUrlÂíåcloudUrlÁî®‰∫ëÁ´ØURL
                                    dataUrl: isVideo ? (mediaFile.thumbnail_url || mediaFile.compressed_url) : (mediaFile.compressed_url || mediaFile.file_url),
                                    originalDataUrl: mediaFile.file_url, // ‰∫ëÁ´ØURLÔºåÁî®‰∫éÊí≠Êîæ
                                    cloudUrl: mediaFile.file_url, // ‰∫ëÁ´ØURL
                                    cloudPath: mediaFile.file_name,
                                    thumbnail: mediaFile.thumbnail_url,
                                    uploaded: true
                                };
                            });

                            posts[post.date].push({
                                caption: post.caption,
                                platforms: post.platforms,
                                files: files
                            });
                        });

                        console.log(`ÊàêÂäüÂä†ËΩΩ ${Object.keys(posts).length} ‰∏™Êó•ÊúüÁöÑÊï∞ÊçÆ`);
                        return posts;
                    } catch (dbError) {
                        console.log('Êï∞ÊçÆÂ∫ìË°®Â∞öÊú™ÂàõÂª∫ÊàñËøûÊé•Â§±Ë¥•Ôºå‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆ');
                        return null;
                    }
                } catch (error) {
                    console.error('SupabaseÂä†ËΩΩÈîôËØØ:', error);
                    return null;
                }
            },

            // Âè™‰ªé‰∫ëÁ´ØÂä†ËΩΩÊñáÊ°àÔºà‰∏çÂä†ËΩΩÊñá‰ª∂Ôºâ
            async loadTextOnlyPosts() {
                if (!isSupabaseConfigured) return null;
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return null;

                    if (DEBUG_MODE) console.log('‰ªé‰∫ëÁ´ØÂä†ËΩΩÊñáÊ°àÊï∞ÊçÆ...');

                    try {
                        // Âè™Âä†ËΩΩÂ∏ñÂ≠êÊï∞ÊçÆÔºå‰∏çÂåÖÂê´Â™í‰ΩìÊñá‰ª∂
                        const { data: postsData, error: postsError } = await supabase
                            .from('posts')
                            .select('*')
                            .eq('user_id', user.id)
                            .order('date', { ascending: true });

                        if (postsError) {
                            if (DEBUG_MODE) console.log('‰∫ëÁ´ØÊöÇÊó†Êï∞ÊçÆÔºå‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆ');
                            return null;
                        }

                        if (!postsData || postsData.length === 0) {
                            if (DEBUG_MODE) console.log('‰∫ëÁ´ØÊñáÊ°àÊï∞ÊçÆ‰∏∫Á©∫');
                            return {};
                        }

                        // ËΩ¨Êç¢‰∏∫ÂéüÊúâÊ†ºÂºèÔºàÂè™ÂåÖÂê´ÊñáÊ°àÔºå‰∏çÂåÖÂê´Êñá‰ª∂Ôºâ
                        const posts = {};
                        postsData.forEach(post => {
                            if (!posts[post.date]) posts[post.date] = [];
                            
                            posts[post.date].push({
                                caption: post.caption,
                                platforms: post.platforms,
                                files: [] // ‰∏çÂä†ËΩΩÊñá‰ª∂Ôºå‰øùÊåÅÁ©∫Êï∞ÁªÑ
                            });
                        });

                        if (DEBUG_MODE) console.log(`ÊàêÂäüÂä†ËΩΩ ${Object.keys(posts).length} ‰∏™Êó•ÊúüÁöÑÊñáÊ°àÊï∞ÊçÆ`);
                        return posts;
                    } catch (dbError) {
                        if (DEBUG_MODE) console.log('Êï∞ÊçÆÂ∫ìË°®Â∞öÊú™ÂàõÂª∫ÊàñËøûÊé•Â§±Ë¥•Ôºå‰øùÊåÅÊú¨Âú∞Êï∞ÊçÆ');
                        return null;
                    }
                } catch (error) {
                    console.error('SupabaseÊñáÊ°àÂä†ËΩΩÈîôËØØ:', error);
                    return null;
                }
            },

            // Áî®Êà∑ËÆ§ËØÅ
            async signIn(email, password) {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email, password
                });
                return { data, error };
            },

            async signUp(email, password) {
                const { data, error } = await supabase.auth.signUp({
                    email, password
                });
                return { data, error };
            },

            async signOut() {
                const { error } = await supabase.auth.signOut();
                return { error };
            },

            async getCurrentUser() {
                const { data: { user } } = await supabase.auth.getUser();
                return user;
            }
        };

        // ËÆ§ËØÅÊ®°ÊÄÅÊ°ÜÁªÑ‰ª∂
        const AuthModal = ({ showTemporaryMessage }) => {
            const [showAuthModal, setShowAuthModal] = React.useState(false);
            const [isSignUp, setIsSignUp] = React.useState(false);
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);

                try {
                    if (isSignUp) {
                        const { data, error } = await SupabaseService.signUp(email, password);
                        if (error) {
                            showTemporaryMessage(error.message, 'error');
                        } else {
                            showTemporaryMessage('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑Ê£ÄÊü•ÈÇÆÁÆ±È™åËØÅÈìæÊé•„ÄÇ', 'success');
                            setShowAuthModal(false);
                        }
                    } else {
                        const { data, error } = await SupabaseService.signIn(email, password);
                        if (error) {
                            showTemporaryMessage(error.message, 'error');
                        } else {
                            showTemporaryMessage('ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
                            setShowAuthModal(false);
                        }
                    }
                } catch (error) {
                    showTemporaryMessage('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <>
                    <button
                        onClick={() => setShowAuthModal(true)}
                        className="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors"
                    >
                        ÁôªÂΩï/Ê≥®ÂÜå
                    </button>

                    {showAuthModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 w-full max-w-md">
                                <h2 className="text-xl font-bold mb-4 text-center">
                                    {isSignUp ? 'Ê≥®ÂÜåË¥¶Âè∑' : 'ÁôªÂΩïË¥¶Âè∑'}
                                </h2>
                                
                                <form onSubmit={handleAuth} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            ÈÇÆÁÆ±
                                        </label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            required
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            ÂØÜÁ†Å
                                        </label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            minLength="6"
                                            required
                                        />
                                    </div>
                                    
                                    <div className="flex gap-3">
                                        <button
                                            type="button"
                                            onClick={() => setShowAuthModal(false)}
                                            className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
                                            disabled={loading}
                                        >
                                            ÂèñÊ∂à
                                        </button>
                                        <button
                                            type="submit"
                                            className="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors disabled:opacity-50"
                                            disabled={loading}
                                        >
                                            {loading ? 'Â§ÑÁêÜ‰∏≠...' : (isSignUp ? 'Ê≥®ÂÜå' : 'ÁôªÂΩï')}
                                        </button>
                                    </div>
                                </form>
                                
                                <div className="mt-4 text-center">
                                    <button
                                        type="button"
                                        onClick={() => setIsSignUp(!isSignUp)}
                                        className="text-sm text-blue-600 hover:text-blue-800"
                                        disabled={loading}
                                    >
                                        {isSignUp ? 'Â∑≤ÊúâË¥¶Âè∑ÔºüÂéªÁôªÂΩï' : 'Ê≤°ÊúâË¥¶Âè∑ÔºüÂéªÊ≥®ÂÜå'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const App = () => {
            const [currentDate, setCurrentDate] = React.useState(new Date());
            const [user, setUser] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [scheduledPosts, setScheduledPosts] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('socialMediaCalendar');
                    const data = saved ? JSON.parse(saved) : {};
                    
                    console.log('Âä†ËΩΩÊú¨Âú∞Êï∞ÊçÆ...');
                    
                    // ÁÆÄÂçïÁöÑÊï∞ÊçÆ‰øÆÂ§çÔºöÂè™Â§ÑÁêÜÊó†ÊïàÁöÑblob URL
                    Object.keys(data).forEach(dayKey => {
                        if (data[dayKey] && Array.isArray(data[dayKey])) {
                            data[dayKey].forEach(post => {
                                if (post.files && Array.isArray(post.files)) {
                                    post.files.forEach(file => {
                                        // ‰øÆÂ§çÊó†ÊïàÁöÑblob URLs
                                        if (file.dataUrl && file.dataUrl.startsWith('blob:')) {
                                            console.warn(`‰øÆÂ§çÊó†ÊïàÁöÑblob URL: ${file.name}`);
                                            file.dataUrl = file.thumbnail || file.originalDataUrl;
                                        }
                                        if (file.originalDataUrl && file.originalDataUrl.startsWith('blob:')) {
                                            file.originalDataUrl = file.dataUrl || file.thumbnail;
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    console.log('Êú¨Âú∞Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
                    return data;
                } catch (error) {
                    console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                    return {};
                }
            });
            const [showModal, setShowModal] = React.useState(false);
            const [selectedDay, setSelectedDay] = React.useState(null);
            const [selectedFiles, setSelectedFiles] = React.useState([]);
            const [selectedPlatforms, setSelectedPlatforms] = React.useState([]);
            const [captionInput, setCaptionInput] = React.useState('');
            const [message, setMessage] = React.useState({ text: '', type: '' });
            const [currentTime, setCurrentTime] = React.useState(new Date());
            const [lightboxMedia, setLightboxMedia] = React.useState(null);
            const [carouselIndices, setCarouselIndices] = React.useState({});
            const [notificationsEnabled, setNotificationsEnabled] = React.useState(false);
            const [uploadProgress, setUploadProgress] = React.useState({});
            const [isUploading, setIsUploading] = React.useState(false);
            const [uploadStatus, setUploadStatus] = React.useState('');
            const [currentLightboxIndex, setCurrentLightboxIndex] = React.useState(0);

            const platforms = [
                { name: 'IG', url: 'https://www.instagram.com/' },
                { name: 'FB', url: 'https://www.facebook.com/' },
                { name: 'Â∞èÁ∫¢‰π¶', url: 'https://www.xiaohongshu.com/' },
                { name: 'ÊäñÈü≥', url: 'https://www.douyin.com/' },
                { name: 'ÂæÆÂçö', url: 'https://weibo.com/' },
                { name: 'ÂæÆ‰ø°', url: 'https://mp.weixin.qq.com/' }
            ];

            // üì¶ Êô∫ËÉΩÂ≠òÂÇ®ÂíåÂêåÊ≠•ÈÄªËæë
            React.useEffect(() => {
                // Èò≤Ê≠¢Á©∫Êï∞ÊçÆËß¶ÂèëÂ≠òÂÇ®
                if (!scheduledPosts || Object.keys(scheduledPosts).length === 0) {
                    return;
                }

                try {
                    // 1. Á´ãÂç≥‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                    const dataToStore = JSON.stringify(scheduledPosts);
                    
                    // Ê£ÄÊü•localStorageÂèØÁî®ÊÄßÂíåÊï∞ÊçÆÂ§ßÂ∞è
                    if (dataToStore.length > 5 * 1024 * 1024) { // 5MBÈôêÂà∂
                        console.warn('‚ö†Ô∏è Êï∞ÊçÆËøáÂ§ßÔºåÂ∞ùËØïËá™Âä®Ê∏ÖÁêÜ...');
                        
                        // Ëá™Âä®Ê∏ÖÁêÜÂ≠òÂÇ®Á©∫Èó¥
                        const cleanedPosts = storageManager.cleanupStorage({...scheduledPosts});
                        const cleanedDataToStore = JSON.stringify(cleanedPosts);
                        
                        if (cleanedDataToStore.length < dataToStore.length) {
                            console.log('‚úÖ Ëá™Âä®Ê∏ÖÁêÜÂÆåÊàêÔºåÊï∞ÊçÆÂ§ßÂ∞èÂáèÂ∞ë');
                            localStorage.setItem('socialMediaCalendar', cleanedDataToStore);
                            showTemporaryMessage('‚úÖ Ëá™Âä®Ê∏ÖÁêÜÂÆåÊàêÔºåÂ≠òÂÇ®Á©∫Èó¥Â∑≤‰ºòÂåñ', 'success');
                            
                            // Êõ¥Êñ∞ReactÁä∂ÊÄÅ‰ª•ÂèçÊò†Ê∏ÖÁêÜÂêéÁöÑÊï∞ÊçÆ
                            setScheduledPosts(cleanedPosts);
                            return;
                        } else {
                            showTemporaryMessage('‚ö†Ô∏è Êï∞ÊçÆÈáèËæÉÂ§ßÔºåÂª∫ËÆÆÊâãÂä®Âà†Èô§‰∏Ä‰∫õÊóßÂÜÖÂÆπ', 'warning');
                        }
                    }
                    
                    localStorage.setItem('socialMediaCalendar', dataToStore);
                    console.log('‚úÖ Êú¨Âú∞Â≠òÂÇ®Â∑≤Êõ¥Êñ∞');
                    
                    // 2. Êõ¥Êñ∞Â≠òÂÇ®ÁªüËÆ°
                    const stats = storageManager.updateStats(scheduledPosts);
                    
                    // 3. Êô∫ËÉΩ‰∫ëÁ´ØÂêåÊ≠•Á≠ñÁï•
                    if (user && isSupabaseConfigured && STORAGE_CONFIG.AUTO_CLOUD_SYNC) {
                        // ËÆæÁΩÆÂêåÊ≠•Áä∂ÊÄÅ
                        storageManager.storageStats.syncStatus = 'syncing';
                        
                        const delayedSync = setTimeout(async () => {
                            try {
                                showTemporaryMessage('üîÑ Êô∫ËÉΩÂêåÊ≠•‰∏≠...', 'info');
                                
                                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈúÄË¶Å‰∫ëÁ´Ø‰∏ä‰º†ÁöÑÊñá‰ª∂
                                let hasCloudFiles = false;
                                Object.values(scheduledPosts).forEach(dayPosts => {
                                    dayPosts.forEach(post => {
                                        if (post.files) {
                                            post.files.forEach(file => {
                                                if (file.needsCloudUpload && !file.cloudUrl) {
                                                    hasCloudFiles = true;
                                                }
                                            });
                                        }
                                    });
                                });
                                
                                if (hasCloudFiles && stats.totalFiles < 10) {
                                    // Â∞èÈáèÊñá‰ª∂ÔºöÂÆåÊï¥ÂêåÊ≠•ÔºàÂåÖÂê´Êñá‰ª∂‰∏ä‰º†Ôºâ
                                    console.log('üì§ ÊâßË°åÂÆåÊï¥ÂêåÊ≠•ÔºàÂåÖÂê´Êñá‰ª∂Ôºâ');
                                    await SupabaseService.savePosts(scheduledPosts);
                                    showTemporaryMessage('‚úÖ ÂÆåÊï¥ÂêåÊ≠•ÊàêÂäüÔºÅ', 'success');
                                } else {
                                    // Â§ßÈáèÊñá‰ª∂ÊàñÊó†ÈúÄ‰∏ä‰º†Ôºö‰ªÖÂêåÊ≠•ÊñáÊ°à
                                    console.log('üìù ÊâßË°åÊñáÊ°àÂêåÊ≠•');
                                    await SupabaseService.savePostsTextOnly(scheduledPosts);
                                    showTemporaryMessage('‚úÖ ÊñáÊ°àÂêåÊ≠•ÂÆåÊàêÔºÅÔºàÊñá‰ª∂‰øùÊåÅÊú¨Âú∞Ôºâ', 'success');
                                }
                                
                                storageManager.storageStats.syncStatus = 'success';
                                
                            } catch (error) {
                                console.error('‚ùå ‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•:', error);
                                storageManager.storageStats.syncStatus = 'error';
                                showTemporaryMessage('‚ö†Ô∏è ‰∫ëÁ´ØÂêåÊ≠•Â§±Ë¥•ÔºåÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂú®Êú¨Âú∞', 'warning');
                            }
                        }, STORAGE_CONFIG.SYNC_DELAY);
                        
                        return () => clearTimeout(delayedSync);
                    }
                } catch (error) {
                    console.error('‚ùå Êú¨Âú∞Â≠òÂÇ®Â§±Ë¥•:', error);
                    
                    // ËØ¶ÁªÜÁöÑÈîôËØØÂ§ÑÁêÜ
                    if (error.name === 'QuotaExceededError' || error.code === 22) {
                        showTemporaryMessage('‚ùå Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåËØ∑Ê∏ÖÁêÜÊµèËßàÂô®Êï∞ÊçÆÊàñÂà†Èô§‰∏Ä‰∫õÊñá‰ª∂', 'error');
                    } else if (error.message.includes('localStorage')) {
                        showTemporaryMessage('‚ùå ÊµèËßàÂô®Â≠òÂÇ®Ë¢´Á¶ÅÁî®ÔºåËØ∑Ê£ÄÊü•ÈöêÁßÅËÆæÁΩÆ', 'error');
                    } else {
                        showTemporaryMessage('‚ùå Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                    }
                }
            }, [scheduledPosts, user]);

            // ÂàùÂßãÂåñÁî®Êà∑ËÆ§ËØÅÁä∂ÊÄÅ
            React.useEffect(() => {
                const initAuth = async () => {
                    if (!isSupabaseConfigured) {
                        setIsLoading(false);
                        return;
                    }

                    try {
                        const currentUser = await SupabaseService.getCurrentUser();
                        setUser(currentUser);

                        // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩïÔºåÂè™ÂêåÊ≠•‰∫ëÁ´ØÊñáÊ°àÔºå‰øùÊåÅÊú¨Âú∞Êñá‰ª∂
                        if (currentUser) {
                            const cloudTextPosts = await SupabaseService.loadTextOnlyPosts();
                            if (cloudTextPosts && Object.keys(cloudTextPosts).length > 0) {
                                // ÁÆÄÂåñÂêàÂπ∂ÔºöÂè™Êõ¥Êñ∞ÊñáÊ°àÂíåÂπ≥Âè∞Ôºå‰øùÊåÅÊâÄÊúâÊú¨Âú∞Êñá‰ª∂
                                setScheduledPosts(prevPosts => {
                                    const mergedPosts = { ...prevPosts };
                                    
                                    Object.entries(cloudTextPosts).forEach(([date, cloudDayPosts]) => {
                                        cloudDayPosts.forEach((cloudPost, index) => {
                                            if (mergedPosts[date] && mergedPosts[date][index]) {
                                                // Âè™Êõ¥Êñ∞ÊñáÊ°àÂíåÂπ≥Âè∞Ôºå‰øùÁïôÊâÄÊúâÊú¨Âú∞Êñá‰ª∂
                                                mergedPosts[date][index] = {
                                                    ...mergedPosts[date][index], // ‰øùÊåÅÂéüÊúâÊï∞ÊçÆÔºàÂåÖÊã¨filesÔºâ
                                                    caption: cloudPost.caption,   // Êõ¥Êñ∞ÊñáÊ°à
                                                    platforms: cloudPost.platforms // Êõ¥Êñ∞Âπ≥Âè∞
                                                };
                                            } else {
                                                // Êñ∞ÁöÑ‰∫ëÁ´ØÊñáÊ°àÊï∞ÊçÆÔºàÊó†Êñá‰ª∂Ôºâ
                                                if (!mergedPosts[date]) mergedPosts[date] = [];
                                                mergedPosts[date][index] = {
                                                    ...cloudPost,
                                                    files: [] // ‰∫ëÁ´ØÂè™ÊúâÊñáÊ°àÔºåÊó†Êñá‰ª∂
                                                };
                                            }
                                        });
                                    });
                                    
                                    return mergedPosts;
                                });
                                showTemporaryMessage('ÊñáÊ°àÂ∑≤ÂêåÊ≠•ÔºàÊñá‰ª∂‰øùÊåÅÊú¨Âú∞Â≠òÂÇ®Ôºâ', 'success');
                            } else {
                                showTemporaryMessage('Â∑≤ÁôªÂΩïÔºåÊñáÊ°àÂ∞ÜÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'success');
                            }
                        }
                    } catch (error) {
                        console.error('ËÆ§ËØÅÂàùÂßãÂåñÂ§±Ë¥•:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };

                initAuth();

                // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
                if (isSupabaseConfigured) {
                    const { data: { subscription } } = supabase.auth.onAuthStateChange(
                        async (event, session) => {
                            setUser(session?.user || null);
                            
                            if (event === 'SIGNED_IN' && session?.user) {
                                showTemporaryMessage('ÁôªÂΩïÊàêÂäüÔºÅÊ≠£Âú®ÂêåÊ≠•ÊñáÊ°à...', 'success');
                                const cloudTextPosts = await SupabaseService.loadTextOnlyPosts();
                                if (cloudTextPosts && Object.keys(cloudTextPosts).length > 0) {
                                    // ÁÆÄÂåñÂêàÂπ∂ÔºöÂè™Êõ¥Êñ∞ÊñáÊ°àÔºå‰øùÊåÅÊâÄÊúâÊú¨Âú∞Êñá‰ª∂
                                    setScheduledPosts(prevPosts => {
                                        const mergedPosts = { ...prevPosts };
                                        
                                        Object.entries(cloudTextPosts).forEach(([date, cloudDayPosts]) => {
                                            cloudDayPosts.forEach((cloudPost, index) => {
                                                if (mergedPosts[date] && mergedPosts[date][index]) {
                                                    // Âè™Êõ¥Êñ∞ÊñáÊ°àÂíåÂπ≥Âè∞Ôºå‰øùÁïôÊâÄÊúâÊú¨Âú∞Êñá‰ª∂
                                                    mergedPosts[date][index] = {
                                                        ...mergedPosts[date][index], // ‰øùÊåÅÂéüÊúâÊï∞ÊçÆÔºàÂåÖÊã¨filesÔºâ
                                                        caption: cloudPost.caption,   // Êõ¥Êñ∞ÊñáÊ°à
                                                        platforms: cloudPost.platforms // Êõ¥Êñ∞Âπ≥Âè∞
                                                    };
                                                } else {
                                                    // Êñ∞ÁöÑ‰∫ëÁ´ØÊñáÊ°àÊï∞ÊçÆÔºàÊó†Êñá‰ª∂Ôºâ
                                                    if (!mergedPosts[date]) mergedPosts[date] = [];
                                                    mergedPosts[date][index] = {
                                                        ...cloudPost,
                                                        files: [] // ‰∫ëÁ´ØÂè™ÊúâÊñáÊ°àÔºåÊó†Êñá‰ª∂
                                                    };
                                                }
                                            });
                                        });
                                        
                                        return mergedPosts;
                                    });
                                    showTemporaryMessage('ÊñáÊ°àÂêåÊ≠•ÂÆåÊàêÔºàÊñá‰ª∂‰øùÊåÅÊú¨Âú∞Ôºâ', 'success');
                                } else {
                                    showTemporaryMessage('ÁôªÂΩïÊàêÂäüÔºÅÊñáÊ°àÂ∞ÜÂêåÊ≠•Âà∞‰∫ëÁ´Ø', 'success');
                                }
                            } else if (event === 'SIGNED_OUT') {
                                showTemporaryMessage('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 'success');
                            }
                        }
                    );

                    return () => subscription.unsubscribe();
                }
            }, []);

            // Êó∂Èó¥Êõ¥Êñ∞
            React.useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // ÈîÆÁõò‰∫ã‰ª∂
            React.useEffect(() => {
                const handleKeyDown = (event) => {
                    if (event.key === 'Escape' && lightboxMedia) {
                        closeLightbox();
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [lightboxMedia]);

            // ËΩÆÊí≠ÈÄªËæë
            React.useEffect(() => {
                const intervals = {};
                Object.keys(scheduledPosts).forEach(dayKey => {
                    const posts = scheduledPosts[dayKey];
                    if (posts.length > 0 && posts[0].files && posts[0].files.length > 1) {
                        intervals[dayKey] = setInterval(() => {
                            setCarouselIndices(prev => {
                                const newIndex = ((prev[dayKey] || 0) + 1) % posts[0].files.length;
                                
                                // ÂΩìËΩÆÊí≠ÂàáÊç¢Êó∂ÔºåÈáçÊñ∞Êí≠ÊîæËßÜÈ¢ë
                                setTimeout(() => {
                                    const videos = document.querySelectorAll(`[data-day-key="${dayKey}"] video`);
                                    videos.forEach(video => {
                                        if (video.currentTime > 0 || video.paused) {
                                            video.currentTime = 0;
                                            video.play().catch(() => {
                                                // ÈùôÈªòÂ§ÑÁêÜÊí≠ÊîæÂ§±Ë¥•
                                            });
                                        }
                                    });
                                }, 100);
                                
                                return {
                                    ...prev,
                                    [dayKey]: newIndex
                                };
                            });
                        }, 5000); // Â¢ûÂä†Âà∞5ÁßíÔºåÁªôËßÜÈ¢ëÊõ¥Â§öÊí≠ÊîæÊó∂Èó¥
                    }
                });
                return () => { 
                    Object.values(intervals).forEach(interval => clearInterval(interval)); 
                };
            }, [scheduledPosts]);

            const showTemporaryMessage = (text, type = 'success') => {
                    setMessage({ text, type });
                    setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const getToday = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return today;
            };

            const getDaysInMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (date) => {
                return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            };

            const getMonthYear = () => {
                return currentDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' });
            };

            const prevMonth = () => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            };

            const nextMonth = () => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            };

            const openModal = (day) => {
                setSelectedDay(day);
                setShowModal(true);
                setSelectedFiles([]);
                setSelectedPlatforms([]);
                setCaptionInput('');
            };

            const closeModal = () => {
                setShowModal(false);
                setSelectedDay(null);
                setSelectedFiles([]);
                setSelectedPlatforms([]);
                setCaptionInput('');
            };

            const openLightbox = (media) => {
                console.log('OpenLightbox called with:', media);
                
                // ÁÆÄÂåñÁöÑÊí≠ÊîæÊ∫êÈÄâÊã©ÔºöÁõ¥Êé•‰ΩøÁî®DataURL
                const processedMedia = {
                    ...media,
                    // Áõ¥Êé•‰ΩøÁî®Â≠òÂÇ®ÁöÑDataURLÔºåËøôÂ∫îËØ•ÊòØÂÆåÊï¥ÁöÑËßÜÈ¢ëÊàñÂõæÁâá
                    dataUrl: media.originalDataUrl || media.dataUrl,
                    type: media.type || (media.name && media.name.includes('.mp4') ? 'video' : 'image')
                };
                
                console.log('Processed media for lightbox:', processedMedia);
                console.log('Using dataUrl:', processedMedia.dataUrl?.substring(0, 50) + '...');
                
                setLightboxMedia(processedMedia);
                setCurrentLightboxIndex(media.currentIndex || 0);
            };

            const closeLightbox = () => {
                setLightboxMedia(null);
            };

            // Âø´ÈÄüÂèëÂ∏ÉÂäüËÉΩ
            const quickPublish = (platform) => {
                const today = getToday().toISOString().split('T')[0];
                const todaysPosts = scheduledPosts[today] || [];
                
                if (todaysPosts.length === 0) {
                    showTemporaryMessage('‰ªäÊó•Ê≤°ÊúâÂæÖÂèëÂ∏ÉÁöÑÂÜÖÂÆπ', 'error');
                        return;
                    }

                const post = todaysPosts[0];
                const caption = post.caption || '';
                
                // Âπ≥Âè∞ÂèëÂ∏ÉÈ°µÈù¢URL
                const publishUrls = {
                    'IG': 'https://www.instagram.com/',
                    'FB': 'https://www.facebook.com/',
                    'Â∞èÁ∫¢‰π¶': 'https://www.xiaohongshu.com/explore',
                    'ÊäñÈü≥': 'https://www.douyin.com/',
                    'ÂæÆÂçö': 'https://weibo.com/u/page/publish',
                    'ÂæÆ‰ø°': 'https://mp.weixin.qq.com/'
                };

                // Â§çÂà∂ÊñáÊ°àÂà∞Ââ™Ë¥¥Êùø
                if (caption) {
                    navigator.clipboard.writeText(caption).then(() => {
                        showTemporaryMessage(`ÊñáÊ°àÂ∑≤Â§çÂà∂ÔºåÊ≠£Âú®Ë∑≥ËΩ¨Âà∞${platform}`, 'success');
                        setTimeout(() => {
                            window.open(publishUrls[platform], '_blank');
                        }, 1000);
                    }).catch(() => {
                        showTemporaryMessage('Â§çÂà∂Â§±Ë¥•Ôºå‰ΩÜ‰ªç‰ºöË∑≥ËΩ¨Âà∞ÂèëÂ∏ÉÈ°µÈù¢', 'error');
                        window.open(publishUrls[platform], '_blank');
                    });
                    } else {
                    window.open(publishUrls[platform], '_blank');
                }
            };

            // ÂØºÂá∫‰ªäÊó•ÂÜÖÂÆπ
            const exportTodayContent = () => {
                const today = getToday().toISOString().split('T')[0];
                const todaysPosts = scheduledPosts[today] || [];
                
                if (todaysPosts.length === 0) {
                    showTemporaryMessage('‰ªäÊó•Ê≤°ÊúâÂæÖÂèëÂ∏ÉÁöÑÂÜÖÂÆπ', 'error');
                    return;
                }

                let content = `üìÖ ${today} ÂèëÂ∏ÉÂÜÖÂÆπ\\n\\n`;
                
                todaysPosts.forEach((post, index) => {
                    content += `„ÄêÁ¨¨${index + 1}Êù°„Äë\\n`;
                    content += `Âπ≥Âè∞Ôºö${post.platforms.join('„ÄÅ')}\\n`;
                    if (post.caption) {
                        content += `ÊñáÊ°àÔºö${post.caption}\\n`;
                    }
                    if (post.files && post.files.length > 0) {
                        content += `Â™í‰ΩìÔºö${post.files.length}‰∏™Êñá‰ª∂\\n`;
                    }
                    content += '\\n';
                });

                // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(content).then(() => {
                    showTemporaryMessage('‰ªäÊó•ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                }).catch(() => {
                    showTemporaryMessage('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
                });
            };

            const handleFileChange = (event) => {
                const files = Array.from(event.target.files);
                const validFiles = files.filter(file => {
                    if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                        showTemporaryMessage(`Êñá‰ª∂ ${file.name} ‰∏çÊòØÊúâÊïàÁöÑÂõæÁâáÊàñËßÜÈ¢ëÊñá‰ª∂„ÄÇ`, 'error');
                        return false;
                    }
                    return true;
                });
                setSelectedFiles(prevFiles => [...prevFiles, ...validFiles]);
            };

            const removeSelectedFile = (indexToRemove) => {
                setSelectedFiles(prevFiles => prevFiles.filter((_, index) => index !== indexToRemove));
            };

            const handlePlatformChange = (platformName) => {
                setSelectedPlatforms(prevPlatforms => {
                    if (prevPlatforms.includes(platformName)) {
                        return prevPlatforms.filter(p => p !== platformName);
                } else {
                        return [...prevPlatforms, platformName];
                    }
                });
            };

            const removeMedia = (day, indexToRemove) => {
                const dayKey = day.toISOString().split('T')[0];
                setScheduledPosts(prevPosts => {
                    const updatedPosts = { ...prevPosts };
                    if (updatedPosts[dayKey]) {
                        updatedPosts[dayKey] = updatedPosts[dayKey].filter((_, index) => index !== indexToRemove);
                        if (updatedPosts[dayKey].length === 0) {
                            delete updatedPosts[dayKey];
                        }
                    }
                    return updatedPosts;
                });
                showTemporaryMessage('ÂÜÖÂÆπÂ∑≤Âà†Èô§„ÄÇ', 'error');
            };

            const compressImage = (file, maxWidth = 1920, quality = 0.8) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            };

            const createVideoThumbnail = (file) => {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        video.currentTime = 1;
                    };
                    
                    video.onseeked = () => {
                        ctx.drawImage(video, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    
                    video.onerror = () => reject(new Error('ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•'));
                    video.src = URL.createObjectURL(file);
                });
            };

            const compressVideo = (file) => {
                return new Promise((resolve, reject) => {
                    // ÂØπ‰∫éËßÜÈ¢ëÊñá‰ª∂ÔºåÊàë‰ª¨Â∞ùËØïÁõ¥Êé•ËΩ¨Êç¢‰∏∫DataURL
                    // Êú¨Âú∞Â≠òÂÇ®Ê®°Âºè‰∏ãÔºåÊàë‰ª¨Â∞ΩÈáè‰øùÂ≠òÂÆåÊï¥ËßÜÈ¢ë
                    const maxSize = 100 * 1024 * 1024; // ÊèêÈ´òÂà∞100MBÈôêÂà∂ÔºåÈÄÇÂ∫îÊú¨Âú∞Â≠òÂÇ®
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const dataUrl = e.target.result;
                        console.log(`ËßÜÈ¢ëËΩ¨Êç¢‰∏∫DataURLÊàêÂäü: ${file.name}, Â§ßÂ∞è: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                        resolve(dataUrl);
                    };
                    reader.onerror = () => {
                        console.error('ËßÜÈ¢ëËØªÂèñÂ§±Ë¥•:', file.name);
                        reject(new Error('ËßÜÈ¢ëËØªÂèñÂ§±Ë¥•'));
                    };
                    
                    if (file.size <= maxSize) {
                        reader.readAsDataURL(file);
                    } else {
                        console.warn(`ËßÜÈ¢ëÊñá‰ª∂ËøáÂ§ß (${(file.size / 1024 / 1024).toFixed(2)} MB)ÔºåÂ∞Ü‰ΩøÁî®Áº©Áï•Âõæ`);
                        reject(new Error('ËßÜÈ¢ëÊñá‰ª∂ËøáÂ§ßÔºåÂ∞Ü‰ΩøÁî®Áº©Áï•Âõæ'));
                    }
                });
            };

            const addMediaToDay = async () => {
                if (selectedFiles.length === 0 && !captionInput.trim()) {
                    showTemporaryMessage('ËØ∑‰∏ä‰º†ÂõæÁâá/ËßÜÈ¢ëÊàñËæìÂÖ•ÊñáÊ°à„ÄÇ', 'error');
                    return;
                }
                if (selectedPlatforms.length === 0) {
                    showTemporaryMessage('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÂèëÂ∏ÉÂπ≥Âè∞„ÄÇ', 'error');
                    return;
                }

                const dayKey = selectedDay.toISOString().split('T')[0];
                const newPost = {
                    platforms: selectedPlatforms,
                    caption: captionInput.trim(),
                    files: []
                };

                if (selectedFiles.length > 0) {
                    try {
                        // üöÄ ‰ΩøÁî®Êô∫ËÉΩÂ≠òÂÇ®ÁÆ°ÁêÜÂô®Â§ÑÁêÜÊñá‰ª∂
                        console.log(`üì¶ ÂºÄÂßãÂ§ÑÁêÜ ${selectedFiles.length} ‰∏™Êñá‰ª∂...`);
                        
                        const filePromises = selectedFiles.map(async (file, index) => {
                            try {
                                if (uploadProgress) {
                                    setUploadProgress(prev => ({ ...prev, [file.name]: 0 }));
                                }
                                
                                console.log(`üìÇ Â§ÑÁêÜÊñá‰ª∂ ${index + 1}/${selectedFiles.length}: ${file.name}`);
                                const processedFile = await storageManager.processFile(file);
                                
                                if (uploadProgress) {
                                    setUploadProgress(prev => ({ ...prev, [file.name]: 100 }));
                                }
                                
                                return processedFile;
                            } catch (error) {
                                console.error(`‚ùå Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•: ${file.name}`, error);
                                return {
                                    type: file.type.startsWith('image/') ? 'image' : 'video',
                                    name: file.name,
                                    size: file.size,
                                    error: error.message,
                                    file: file
                                };
                            }
                        });
                        
                        const fileData = await Promise.all(filePromises);
                        newPost.files = fileData;
                        
                        // üìä Êõ¥Êñ∞Â≠òÂÇ®ÁªüËÆ°
                        const stats = storageManager.updateStats({ ...scheduledPosts, [dayKey]: [newPost] });
                        console.log('üìä Â≠òÂÇ®ÁªüËÆ°:', stats);
                        
                    } catch (error) {
                        console.error('‚ùå Êñá‰ª∂ÊâπÈáèÂ§ÑÁêÜÂ§±Ë¥•:', error);
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊàêÂäüÂ§ÑÁêÜÁöÑÊñá‰ª∂
                        const validFiles = newPost.files.filter(file => !file.error);
                        if (validFiles.length > 0) {
                            newPost.files = validFiles;
                            showTemporaryMessage(`‚ö†Ô∏è ${selectedFiles.length - validFiles.length} ‰∏™Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•Ôºå${validFiles.length} ‰∏™Êñá‰ª∂ÊàêÂäü‰øùÂ≠ò`, 'warning');
                        } else {
                            showTemporaryMessage('‚ùå ÊâÄÊúâÊñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÂíåÂ§ßÂ∞è', 'error');
                            return;
                        }
                    }
                }

                setScheduledPosts(prevPosts => {
                    const updatedPosts = { ...prevPosts };
                    if (!updatedPosts[dayKey]) {
                        updatedPosts[dayKey] = [];
                    }
                    updatedPosts[dayKey].push(newPost);
                    return updatedPosts;
                });

                showTemporaryMessage('ÂÜÖÂÆπÂ∑≤Ê∑ªÂä†Âà∞Êó•ÂéÜÔºÅ', 'success');
                closeModal();
            };

            const renderCalendarDays = () => {
                const totalDays = getDaysInMonth(currentDate);
                const firstDayIndex = getFirstDayOfMonth(currentDate);
                const days = [];
                const today = getToday();

                for (let i = 0; i < firstDayIndex; i++) {
                    days.push(
                        <div key={`empty-${i}`} className="flex flex-col">
                            <div className="aspect-9-16 calendar-cell bg-white"></div>
                            <div className="flex justify-center py-2">
                                <span className="text-transparent text-sm">+</span>
                            </div>
                        </div>
                    );
                }

                for (let day = 1; day <= totalDays; day++) {
                    const currentDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    currentDay.setHours(0, 0, 0, 0);
                    const dayKey = currentDay.toISOString().split('T')[0];
                    const postsForDay = scheduledPosts[dayKey] || [];

                    let cellClass = 'calendar-cell bg-white';
                    if (currentDay.getTime() === today.getTime()) {
                        cellClass = 'calendar-cell today-cell';
                    } else if (currentDay.getTime() < today.getTime()) {
                        cellClass = 'calendar-cell past-cell';
                    }

                    days.push(
                        <div key={dayKey} className="flex flex-col">
                            <div className={`relative ${cellClass} aspect-9-16`} data-day-key={dayKey}>
                                <div className="absolute top-2 left-2 text-xs text-gray-400 z-10" style={{fontWeight: 300}}>{day}</div>
                                
                                {postsForDay.length > 0 ? (
                                    postsForDay[0].files && postsForDay[0].files.length > 0 ? (
                                        <div className="relative group media-container">
                                            <button
                                                onClick={() => removeMedia(currentDay, 0)}
                                                className="absolute top-2 right-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity bg-blue-500 text-white rounded-full p-1 shadow-md hover:bg-blue-600"
                                                title="Âà†Èô§ÂÜÖÂÆπ"
                                            >
                                                <XCircle />
                                            </button>
                                            
                                            {/* Â§ö‰∏™Êñá‰ª∂Êó∂ÊòæÁ§∫ËΩÆÊí≠ÊåáÁ§∫Âô® */}
                                            {postsForDay[0].files.length > 1 && (
                                                <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 z-10 flex space-x-1 bg-black bg-opacity-30 px-2 py-1 rounded-full">
                                                    {postsForDay[0].files.map((_, index) => (
                                                        <div
                                                            key={index}
                                                            className={`w-1.5 h-1.5 rounded-full ${
                                                                index === (carouselIndices[dayKey] || 0) 
                                                                    ? 'bg-white' 
                                                                    : 'bg-white bg-opacity-50'
                                                            }`}
                                                        />
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {(() => {
                                                const currentFileIndex = carouselIndices[dayKey] || 0;
                                                const currentFile = postsForDay[0].files[currentFileIndex];
                                                
                                                if (currentFile.type === 'image') {
                                                    return (
                                                        <img
                                                            src={currentFile.dataUrl || currentFile.originalDataUrl}
                                                            alt="ÂÜÖÂÆπÂõæÁâá"
                                                            className="cursor-pointer"
                                                            onClick={() => openLightbox({
                                                                ...currentFile,
                                                                // ÂØπ‰∫éÂõæÁâáÔºå‰ΩøÁî®È´òË¥®ÈáèÁöÑoriginalDataUrlÊàñcloudUrl
                                                                dataUrl: currentFile.cloudUrl || currentFile.originalDataUrl || currentFile.dataUrl,
                                                                caption: postsForDay[0].caption,
                                                                allFiles: postsForDay[0].files,
                                                                currentIndex: currentFileIndex
                                                            })}
                                                        />
                                                    );
                                                } else {
                                                    return (
                                                        <div 
                                                            className="w-full h-full cursor-pointer"
                                                            onClick={() => openLightbox({
                                                                ...currentFile,
                                                                // ÂØπ‰∫éËßÜÈ¢ëÔºå‰øùÊåÅcloudUrlÁî®‰∫éÊí≠Êîæ
                                                                dataUrl: currentFile.cloudUrl || currentFile.originalDataUrl || currentFile.dataUrl,
                                                                caption: postsForDay[0].caption,
                                                                allFiles: postsForDay[0].files,
                                                                currentIndex: currentFileIndex
                                                            })}
                                                        >
                                                            {/* ÁÆÄÂåñÁöÑËßÜÈ¢ëÊòæÁ§∫ÔºöÁõ¥Êé•‰ΩøÁî®DataURL */}
                                                            {currentFile.dataUrl && currentFile.dataUrl.startsWith('data:video/') ? (
                                                                <video
                                                                    src={currentFile.dataUrl}
                                                                    className="w-full h-full object-cover calendar-video"
                                                                    autoPlay
                                                                    muted
                                                                    loop
                                                                    playsInline
                                                                    preload="metadata"
                                                                    onClick={(e) => e.stopPropagation()}
                                                                    onError={(e) => {
                                                                        console.error('ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•:', currentFile.name);
                                                                    }}
                                                                    onLoadedData={() => {
                                                                        if (DEBUG_MODE) console.log('ËßÜÈ¢ëÊí≠ÊîæÊàêÂäü:', currentFile.name);
                                                                    }}
                                                                />
                                                            ) : currentFile.thumbnail ? (
                                                                <div className="w-full h-full relative">
                                                                    <img
                                                                        src={currentFile.thumbnail}
                                                                        alt="ËßÜÈ¢ëÁº©Áï•Âõæ"
                                                                        className="w-full h-full object-cover"
                                                                    />
                                                                    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20">
                                                                        <div className="bg-white bg-opacity-90 rounded-full p-2">
                                                                            <span className="text-gray-700 text-xl">‚ñ∂</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div className="w-full h-full bg-gray-200 flex items-center justify-center">
                                                                    <div className="text-center">
                                                                        <span className="text-4xl">üé•</span>
                                                                        <div className="text-xs text-gray-500 mt-1">ËßÜÈ¢ëÂä†ËΩΩ‰∏≠</div>
                                                                    </div>
                                            </div>
                                        )}

                                        </div>
                                                    );
                                                }
                                            })()}
                                        </div>
                                    ) : (
                                        postsForDay[0].caption && (
                                            <div className="relative group w-full h-full">
                                            <button
                                                    onClick={() => removeMedia(currentDay, 0)}
                                                    className="absolute top-2 right-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity bg-blue-500 text-white rounded-full p-1 shadow-md hover:bg-blue-600"
                                                title="Âà†Èô§ÂÜÖÂÆπ"
                                            >
                                                    <XCircle size={12} />
                                            </button>
                                                
                                                <div 
                                                    className="w-full h-full p-3 cursor-pointer bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 hover:from-blue-100 hover:to-indigo-100 transition-colors flex items-center justify-center"
                                                    onClick={() => openLightbox({
                                                        type: 'text',
                                                        caption: postsForDay[0].caption
                                                    })}
                                                >
                                                    <p className="text-gray-700 text-xs leading-relaxed text-center line-clamp-6 font-medium">
                                                        {postsForDay[0].caption.length > 60 
                                                            ? postsForDay[0].caption.substring(0, 60) + '...' 
                                                            : postsForDay[0].caption
                                                        }
                                                    </p>
                                        </div>
                                    </div>
                                        )
                                    )
                                ) : null}
                            </div>
                            
                            <div className="flex justify-center py-2">
                            <button
                                onClick={() => openModal(currentDay)}
                                    className="text-gray-300 hover:text-gray-500 transition-colors text-sm"
                                    title="Ê∑ªÂä†ÂÜÖÂÆπ"
                            >
                                    +
                            </button>
                            </div>
                        </div>
                    );
                }
                return days;
            };

            // üìä Â≠òÂÇ®Áä∂ÊÄÅÁªÑ‰ª∂
            const StorageStatusDisplay = () => {
                const [storageStats, setStorageStats] = React.useState(storageManager.storageStats);
                
                React.useEffect(() => {
                    const interval = setInterval(() => {
                        setStorageStats({...storageManager.storageStats});
                    }, 1000);
                    return () => clearInterval(interval);
                }, []);
                
                const formatSize = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                const getSyncStatusIcon = () => {
                    switch (storageStats.syncStatus) {
                        case 'syncing': return 'üîÑ';
                        case 'success': return '‚úÖ';
                        case 'error': return '‚ùå';
                        default: return 'üíæ';
                    }
                };
                
                const getSyncStatusText = () => {
                    switch (storageStats.syncStatus) {
                        case 'syncing': return 'ÂêåÊ≠•‰∏≠';
                        case 'success': return 'Â∑≤ÂêåÊ≠•';
                        case 'error': return 'ÂêåÊ≠•Â§±Ë¥•';
                        default: return 'Êú¨Âú∞Â≠òÂÇ®';
                    }
                };
                
                // Ê£ÄÊü•Â≠òÂÇ®Á©∫Èó¥‰ΩøÁî®Áéá
                const getStorageUsageColor = () => {
                    const usage = storageStats.localSize / (10 * 1024 * 1024); // ÂÅáËÆæ10MB‰∏∫Êª°ÂÆπÈáè
                    if (usage > 0.8) return 'text-red-500';
                    if (usage > 0.6) return 'text-yellow-500';
                    return 'text-green-500';
                };

                return (
                    <div className="fixed bottom-4 left-4 z-40 bg-white rounded-lg shadow-lg p-3 border text-xs max-w-xs">
                        <div className="flex items-center gap-2 mb-2">
                            <span className="text-lg">{getSyncStatusIcon()}</span>
                            <span className="font-medium">{getSyncStatusText()}</span>
                        </div>
                        <div className="space-y-1 text-gray-600">
                            <div>üìÅ {storageStats.totalFiles} ‰∏™Êñá‰ª∂</div>
                            <div className={`üíæ Êú¨Âú∞: ${formatSize(storageStats.localSize)} ${getStorageUsageColor()}`}>
                                üíæ Êú¨Âú∞: <span className={getStorageUsageColor()}>{formatSize(storageStats.localSize)}</span>
                            </div>
                            {storageStats.cloudSize > 0 && (
                                <div>‚òÅÔ∏è ‰∫ëÁ´Ø: {formatSize(storageStats.cloudSize)}</div>
                            )}
                            
                            {/* Â≠òÂÇ®Á©∫Èó¥Ë≠¶Âëä */}
                            {storageStats.localSize > 8 * 1024 * 1024 && (
                                <div className="text-red-500 text-xs mt-1">
                                    ‚ö†Ô∏è Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥
                                </div>
                            )}
                        </div>
                        
                        {/* ÈîôËØØÁä∂ÊÄÅ‰∏ãÊòæÁ§∫Êõ¥Â§ö‰ø°ÊÅØ */}
                        {storageStats.syncStatus === 'error' && (
                            <div className="mt-2 pt-2 border-t text-xs text-red-500">
                                üí° Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÂà∑Êñ∞È°µÈù¢ÈáçËØï
                            </div>
                        )}
                    </div>
                );
            };

                return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-6 font-sans antialiased">
                    <div className="max-w-7xl mx-auto bg-white relative">
                        


                        {/* È°∂ÈÉ®ÊéßÂà∂Ê†è */}
                        <div className="flex justify-between items-start p-4 md:p-8 pb-4">
                            {/* Â∑¶‰æßÔºöSupabaseÁä∂ÊÄÅÂíåËÆ§ËØÅ */}
                            <div className="text-sm text-gray-600">
                                {isSupabaseConfigured ? (
                                    <div className="flex items-center gap-4">
                                        {user ? (
                                            <div className="flex items-center gap-2">
                                                <span className="text-green-600">üü¢</span>
                                                <span>‰∫ëÁ´ØÂêåÊ≠•Â∑≤ÂºÄÂêØ</span>
                                                <button
                                                    onClick={async () => {
                                                        await SupabaseService.signOut();
                                                    }}
                                                    className="text-xs px-2 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors"
                                                >
                                                    ÈÄÄÂá∫
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="flex items-center gap-2">
                                                <span className="text-orange-600">üü°</span>
                                                <span>Êú¨Âú∞Â≠òÂÇ®</span>
                                                <AuthModal showTemporaryMessage={showTemporaryMessage} />
                                                            </div>
                                                        )}
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2">
                                        <span className="text-gray-400">‚ö´</span>
                                        <span className="text-xs text-gray-500">
                                            Êú¨Âú∞Ê®°ÂºèÔºàÈúÄÈÖçÁΩÆSupabaseÂêØÁî®‰∫ëÁ´ØÂêåÊ≠•Ôºâ
                                                                </span>
                                                        </div>
                                )}
                            </div>
                            
                            {/* Âè≥‰æßÔºöÁé∞ÊúâÊéßÂà∂ÊåâÈíÆ */}
                            <div className="text-sm text-gray-600 font-medium text-right">
                                <div className="flex flex-col items-end gap-2 mb-4">
                                    {/* ‰ªäÊó•ÂÜÖÂÆπÂø´ÈÄüÂèëÂ∏ÉÊåâÈíÆ */}
                                    <div className="flex gap-2 mb-2">
                                                            <button
                                            onClick={exportTodayContent}
                                            className="text-xs px-2 py-1 bg-purple-50 text-purple-600 rounded hover:bg-purple-100 transition-colors"
                                            title="Â§çÂà∂‰ªäÊó•ÂèëÂ∏ÉÂÜÖÂÆπ"
                                        >
                                            üìã ‰ªäÊó•ÂÜÖÂÆπ
                                                            </button>
                                                        </div>
                                    
                                    {/* Âø´ÈÄüÂèëÂ∏ÉÊåâÈíÆ */}
                                    {(() => {
                                        const today = getToday().toISOString().split('T')[0];
                                        const todaysPosts = scheduledPosts[today] || [];
                                        if (todaysPosts.length > 0 && todaysPosts[0].platforms) {
                                            return (
                                                <div className="flex gap-1 mb-2 flex-wrap justify-end">
                                                    {todaysPosts[0].platforms.map(platform => (
                                                        <button
                                                            key={platform}
                                                            onClick={() => quickPublish(platform)}
                                                            className="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors"
                                                            title={`Âø´ÈÄüÂèëÂ∏ÉÂà∞${platform}`}
                                                        >
                                                            üöÄ {platform}
                                                        </button>
                        ))}
                    </div>
                );
                                        }
                                        return null;
                                    })()}
                                    
                                    <div className="text-xs text-gray-500">
                                        Â≠òÂÇ®: {Object.keys(scheduledPosts).length} ‰∏™Êó•Êúü
                                    </div>
                                </div>
                            {currentTime.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                            <br />
                            {currentTime.toLocaleTimeString('zh-CN')}
                            </div>
                        </div>

                        {/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */}
                        <div className="px-4 md:px-8 pb-4 md:pb-8">

                        {message.text && (
                            <div className={`p-3 mb-4 rounded-lg text-center font-medium ${message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="flex items-center justify-center mb-8 gap-3">
                                <button
                                    onClick={prevMonth}
                                className="nav-button flex items-center justify-center w-12 h-12 text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-all text-2xl font-light rounded-full"
                                    aria-label="‰∏ä‰∏™Êúà"
                                >
                                <ChevronLeft />
                                </button>
                            <h2 className="text-3xl md:text-4xl lg:text-5xl text-gray-400 tracking-widest uppercase" style={{fontWeight: 200}}>
                                    {getMonthYear()}
                                </h2>
                                <button
                                    onClick={nextMonth}
                                className="nav-button flex items-center justify-center w-12 h-12 text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-all text-2xl font-light rounded-full"
                                    aria-label="‰∏ã‰∏™Êúà"
                                >
                                <ChevronRight />
                                </button>
                            </div>

                        <div className="grid grid-cols-7 gap-0 mb-4 text-center text-gray-400 text-sm tracking-wider">
                            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, index) => (
                                <div key={index} className="py-4" style={{fontWeight: 300}}>{day}</div>
                                    ))}
                                </div>

                        <div className="grid grid-cols-7 gap-0">
                                    {renderCalendarDays()}
                    </div>

                        {/* Ê∑ªÂä†ÂÜÖÂÆπÊ®°ÊÄÅÊ°Ü */}
                    {showModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
                                    <h2 className="text-xl font-bold mb-4">
                                        {selectedDay && `${selectedDay.getFullYear()}Âπ¥${selectedDay.getMonth() + 1}Êúà${selectedDay.getDate()}Êó•`}
                                    </h2>

                                <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">ÈÄâÊã©Âπ≥Âè∞</label>
                                        <div className="flex flex-wrap gap-2">
                                            {platforms.map(platform => (
                                                <button
                                                    key={platform.name}
                                                    onClick={() => handlePlatformChange(platform.name)}
                                                    className={`px-3 py-1 text-sm rounded ${
                                                        selectedPlatforms.includes(platform.name)
                                                            ? 'bg-blue-500 text-white'
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    {platform.name}
                                                </button>
                                            ))}
                                            </div>
                                </div>

                                <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">ÊñáÊ°àÂÜÖÂÆπ</label>
                                    <textarea
                                        value={captionInput}
                                        onChange={(e) => setCaptionInput(e.target.value)}
                                            placeholder="ËæìÂÖ•ÂèëÂ∏ÉÊñáÊ°à..."
                                            className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            rows="4"
                                        />
                                </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">‰∏ä‰º†ÂõæÁâá/ËßÜÈ¢ë</label>
                                                <input
                                            type="file"
                                            multiple
                                            accept="image/*,video/*"
                                            onChange={handleFileChange}
                                            className="w-full p-2 border border-gray-300 rounded"
                                        />
                                    </div>

                                    {selectedFiles.length > 0 && (
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">È¢ÑËßàÊñá‰ª∂</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {selectedFiles.map((file, index) => (
                                                    <div key={index} className="relative">
                                                        {file.type.startsWith('image/') ? (
                                                            <img
                                                                src={URL.createObjectURL(file)}
                                                                alt={file.name}
                                                                className="w-full h-20 object-cover rounded border cursor-pointer"
                                                                onClick={() => openLightbox({type: 'image', dataUrl: URL.createObjectURL(file), name: file.name})}
                                                            />
                                                        ) : (
                                                            <div
                                                                className="w-full h-20 bg-gray-100 rounded border flex items-center justify-center cursor-pointer"
                                                                onClick={() => openLightbox({type: 'video', dataUrl: URL.createObjectURL(file), name: file.name})}
                                                            >
                                                                <span className="text-2xl">üé•</span>
                                                            </div>
                                                        )}
                                                        <button
                                                            onClick={() => removeSelectedFile(index)}
                                                            className="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-blue-600"
                                                        >
                                                            √ó
                                                        </button>
                                                        <div className="text-xs text-gray-500 mt-1 truncate">{file.name}</div>
                                                    </div>
                                        ))}
                                    </div>
                                </div>
                                    )}

                                    <div className="flex gap-3">
                                    <button
                                        onClick={closeModal}
                                            className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
                                    >
                                        ÂèñÊ∂à
                                    </button>
                                    <button
                                        onClick={addMediaToDay}
                                            className="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                                    >
                                            ‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                        {/* LightboxÊ®°ÊÄÅÊ°Ü */}
                        {lightboxMedia && (
                            <div 
                                className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4"
                                onClick={closeLightbox}
                            >
                                <div className="flex max-w-7xl max-h-full w-full gap-6" onClick={(e) => e.stopPropagation()}>
                                    <button
                                        onClick={closeLightbox}
                                        className="absolute top-6 right-6 z-60 bg-white bg-opacity-20 text-white rounded-full p-2 hover:bg-opacity-30 transition-colors"
                                        title="ÂÖ≥Èó≠"
                                    >
                                        <XCircle />
                                    </button>
                                    
                                    {/* Â™í‰ΩìÂÜÖÂÆπÂå∫Âüü */}
                                    <div className="flex-1 flex items-center justify-center relative">
                                        {/* Â§öÊñá‰ª∂Êó∂ÁöÑÂ∑¶Âè≥ÂàáÊç¢ÊåâÈíÆ */}
                                        {lightboxMedia.allFiles && lightboxMedia.allFiles.length > 1 && (
                                            <>
                                                <button
                                                    onClick={() => {
                                                        const allFiles = lightboxMedia.allFiles;
                                                        const newIndex = (currentLightboxIndex - 1 + allFiles.length) % allFiles.length;
                                                        setCurrentLightboxIndex(newIndex);
                                                    }}
                                                    className="absolute left-4 z-50 bg-white bg-opacity-20 text-white rounded-full p-3 hover:bg-opacity-30 transition-colors"
                                                    title="‰∏ä‰∏Ä‰∏™"
                                                >
                                                    <ChevronLeft />
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        const allFiles = lightboxMedia.allFiles;
                                                        const newIndex = (currentLightboxIndex + 1) % allFiles.length;
                                                        setCurrentLightboxIndex(newIndex);
                                                    }}
                                                    className="absolute right-4 z-50 bg-white bg-opacity-20 text-white rounded-full p-3 hover:bg-opacity-30 transition-colors"
                                                    title="‰∏ã‰∏Ä‰∏™"
                                                >
                                                    <ChevronRight />
                                                </button>
                                            </>
                                        )}

                                        {/* Â™í‰ΩìÊòæÁ§∫Âå∫Âüü */}
                                        {(() => {
                                            const currentMedia = lightboxMedia.allFiles ? 
                                                lightboxMedia.allFiles[currentLightboxIndex] : 
                                                lightboxMedia;
                                            
                                            if (currentMedia.type === 'image') {
                                                return (
                                                    <img
                                                        src={currentMedia.originalDataUrl || currentMedia.dataUrl}
                                                        alt={currentMedia.name}
                                                        className="max-w-full max-h-full object-contain rounded-lg"
                                                    />
                                                );
                                            } else if (currentMedia.type === 'video') {
                                                // Êô∫ËÉΩÈÄâÊã©ËßÜÈ¢ëÊ∫êÔºö‰∫ëÁ´ØURL > Êú¨Âú∞ÂéãÁº©ËßÜÈ¢ë > ÂéüÂßãËßÜÈ¢ë > Áº©Áï•Âõæ
                                                const videoSrc = currentMedia.cloudUrl ||  // ‰ºòÂÖà‰ΩøÁî®‰∫ëÁ´ØURL
                                                               (currentMedia.dataUrl && currentMedia.dataUrl.startsWith('data:video/') ? currentMedia.dataUrl : null) ||
                                                               (currentMedia.originalDataUrl && currentMedia.originalDataUrl.startsWith('data:video/') ? currentMedia.originalDataUrl : null) ||
                                                               (currentMedia.dataUrl && currentMedia.dataUrl.startsWith('blob:') ? currentMedia.dataUrl : null) ||
                                                               (currentMedia.originalDataUrl && currentMedia.originalDataUrl.startsWith('blob:') ? currentMedia.originalDataUrl : null);
                                                
                                                if (videoSrc) {
                                                    return (
                                                        <video
                                                            src={videoSrc}
                                                            controls
                                                            autoPlay
                                                            className="max-w-full max-h-full object-contain rounded-lg"
                                                            onError={(e) => {
                                                                console.error('ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•:', videoSrc);
                                                                // Â¶ÇÊûú‰∫ëÁ´ØËßÜÈ¢ëÂ§±Ë¥•ÔºåÂ∞ùËØïÊú¨Âú∞ËßÜÈ¢ë
                                                                if (currentMedia.cloudUrl && (currentMedia.dataUrl || currentMedia.originalDataUrl)) {
                                                                    const fallbackSrc = (currentMedia.dataUrl && currentMedia.dataUrl.startsWith('data:video/')) ? 
                                                                                       currentMedia.dataUrl : currentMedia.originalDataUrl;
                                                                    if (fallbackSrc && fallbackSrc !== videoSrc) {
                                                                        e.target.src = fallbackSrc;
                                                                    }
                                                                }
                                                            }}
                                                        >
                                                            ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊ†áÁ≠æ„ÄÇ
                                                        </video>
                                                    );
                                                } else {
                                                    // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑËßÜÈ¢ëÊ∫êÔºåÊòæÁ§∫Áº©Áï•Âõæ
                                                    return (
                                                        <div className="flex flex-col items-center justify-center text-gray-400">
                                                            {currentMedia.thumbnail ? (
                                                                <img
                                                                    src={currentMedia.thumbnail}
                                                                    alt="ËßÜÈ¢ëÁº©Áï•Âõæ"
                                                                    className="max-w-full max-h-full object-contain rounded-lg mb-4"
                                                                />
                                                            ) : (
                                                                <div className="text-8xl mb-4">üé•</div>
                                                            )}
                                                            <p className="text-lg">ËßÜÈ¢ëÈ¢ÑËßà‰∏çÂèØÁî®</p>
                                                            <p className="text-sm">Êñá‰ª∂Ôºö{currentMedia.name}</p>
                                                        </div>
                                                    );
                                                }
                                            } else {
                                                return (
                                                    <div className="flex items-center justify-center text-gray-400 text-xl">
                                                        üìù ÊñáÂ≠óÂÜÖÂÆπ
                                                    </div>
                                                );
                                            }
                                        })()}

                                        {/* ËΩÆÊí≠ÊåáÁ§∫Âô® */}
                                        {lightboxMedia.allFiles && lightboxMedia.allFiles.length > 1 && (
                                            <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex space-x-2">
                                                {lightboxMedia.allFiles.map((_, index) => (
                                                    <button
                                                        key={index}
                                                        onClick={() => setCurrentLightboxIndex(index)}
                                                        className={`w-3 h-3 rounded-full transition-colors ${
                                                            index === currentLightboxIndex 
                                                                ? 'bg-white' 
                                                                : 'bg-white bg-opacity-50 hover:bg-opacity-75'
                                                        }`}
                                                    />
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Âè≥‰æßÊñáÂ≠óÂÜÖÂÆπÂå∫Âüü */}
                                    <div className="w-80 bg-white rounded-lg p-6 flex flex-col max-h-full">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-lg font-semibold text-gray-800">ÊñáÊ°àÂÜÖÂÆπ</h3>
                                            <button
                                                onClick={async () => {
                                                    try {
                                                        await navigator.clipboard.writeText(lightboxMedia.caption || '');
                                                        showTemporaryMessage('ÊñáÊ°àÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                                                    } catch (err) {
                                                        showTemporaryMessage('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
                                                    }
                                                }}
                                                className="px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-colors flex items-center gap-1"
                                                title="Â§çÂà∂ÊñáÊ°à"
                                            >
                                                üìã Â§çÂà∂
                                            </button>
                                        </div>
                                        
                                        {/* ÊñáÊ°àÂÜÖÂÆπ */}
                                        <div className="flex-1 overflow-y-auto border rounded-md p-4 bg-gray-50 mb-4">
                                            <p className="text-gray-700 leading-relaxed whitespace-pre-wrap text-base font-normal">
                                                {lightboxMedia.caption || 'ÊöÇÊó†ÊñáÊ°àÂÜÖÂÆπ'}
                                            </p>
                                        </div>

                                        {/* Êñá‰ª∂‰ø°ÊÅØ */}
                                        <div className="border-t pt-4">
                                            <h4 className="text-sm font-medium text-gray-800 mb-2">
                                                Êñá‰ª∂‰ø°ÊÅØ {lightboxMedia.allFiles ? `(${currentLightboxIndex + 1}/${lightboxMedia.allFiles.length})` : '(1/1)'}
                                            </h4>
                                            <div className="text-xs text-gray-600 space-y-1">
                                                {(() => {
                                                    const currentMedia = lightboxMedia.allFiles ? 
                                                        lightboxMedia.allFiles[currentLightboxIndex] : 
                                                        lightboxMedia;
                                                    return (
                                                        <>
                                                            <div>Êñá‰ª∂Âêç: {currentMedia.name || 'Êú™Áü•'}</div>
                                                            <div>Á±ªÂûã: {currentMedia.type === 'image' ? 'ÂõæÁâá' : currentMedia.type === 'video' ? 'ËßÜÈ¢ë' : 'ÊñáÊú¨'}</div>
                                                            {currentMedia.size && (
                                                                <div>Â§ßÂ∞è: {(currentMedia.size / 1024 / 1024).toFixed(2)} MB</div>
                                                            )}
                                                        </>
                                                    );
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        </div>
                        
                        {/* Â≠òÂÇ®Áä∂ÊÄÅÊòæÁ§∫ */}
                        <StorageStatusDisplay />
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>